#!/bin/sh
set -e

ARTIFACT_ROOT="/opt/dominium/artifact_root"
CORE_BIN="$ARTIFACT_ROOT/setup/dominium-setup"
ADAPTER_BIN="$ARTIFACT_ROOT/setup/dominium-setup-linux"
MANIFEST_PATH="setup/manifests/product.dsumanifest"
INVOCATION_PATH="${TMPDIR:-/tmp}/dominium_install.dsuinv"
PLAN_PATH="${TMPDIR:-/tmp}/dominium_install.dsuplan"
STATE_PATH="/opt/dominium/.dsu/installed_state.dsustate"

if [ -x "$CORE_BIN" ]; then
    (
        cd "$ARTIFACT_ROOT"
        "$CORE_BIN" --deterministic 1 export-invocation --manifest "$MANIFEST_PATH" --op install --scope system --ui-mode cli --frontend-id deb --out "$INVOCATION_PATH" || true
        "$CORE_BIN" --deterministic 1 plan --manifest "$MANIFEST_PATH" --invocation "$INVOCATION_PATH" --out "$PLAN_PATH" || true
        "$CORE_BIN" --deterministic 1 apply --plan "$PLAN_PATH" || true
    )
fi

if [ -x "$ADAPTER_BIN" ] && [ -f "$STATE_PATH" ]; then
    "$ADAPTER_BIN" platform-register --state "$STATE_PATH" --deterministic || true
fi

exit 0
