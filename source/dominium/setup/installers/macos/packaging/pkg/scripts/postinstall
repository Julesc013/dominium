#!/bin/sh
set -e

ARTIFACT_ROOT="/Library/Application Support/Dominium/setup/artifact_root"
INVOCATION_PATH="/Library/Application Support/Dominium/setup/invocation.tlv"
MANIFEST_PATH="setup/manifests/product.dsumanifest"
CLI_BIN="$ARTIFACT_ROOT/setup/dominium-setup"
PLAN_PATH="${TMPDIR:-/tmp}/dominium-plan.tlv"

if [ ! -x "$CLI_BIN" ]; then
  echo "dominium-setup not found: $CLI_BIN" >&2
  exit 1
fi
if [ ! -f "$INVOCATION_PATH" ]; then
  echo "invocation payload not found: $INVOCATION_PATH" >&2
  exit 1
fi

(
  cd "$ARTIFACT_ROOT"
  "$CLI_BIN" --deterministic 1 plan --manifest "$MANIFEST_PATH" --invocation "$INVOCATION_PATH" --out "$PLAN_PATH"
  "$CLI_BIN" --deterministic 1 apply --plan "$PLAN_PATH"
)

exit 0
