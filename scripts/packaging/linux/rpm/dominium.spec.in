Name:           dominium
Version:        @VERSION@
Release:        @RELEASE@%{?dist}
Summary:        Dominium launcher and setup

License:        MIT
URL:            https://example.com/dominium
BuildArch:      x86_64
Requires:       @REQUIRES@

%description
Dominium binaries and setup helper. Installation and repair are performed by
dominium-setup for consistent layout across platforms.

%prep
%setup -T -c -a 0

%build
# Binaries are prebuilt; nothing to compile here.

%install
rm -rf %{buildroot}
mkdir -p %{buildroot}/opt/dominium/artifact_root
cp -a %{_sourcedir}/dominium/artifact_root/. %{buildroot}/opt/dominium/artifact_root/

%post
if [ -x /opt/dominium/artifact_root/setup/dominium-setup ]; then
    cd /opt/dominium/artifact_root
    /opt/dominium/artifact_root/setup/dominium-setup --deterministic 1 export-invocation --manifest setup/manifests/product.dsumanifest --op install --scope system --ui-mode cli --frontend-id rpm --out /tmp/dominium_install.dsuinv || true
    /opt/dominium/artifact_root/setup/dominium-setup --deterministic 1 plan --manifest setup/manifests/product.dsumanifest --invocation /tmp/dominium_install.dsuinv --out /tmp/dominium_install.dsuplan || true
    /opt/dominium/artifact_root/setup/dominium-setup --deterministic 1 apply --plan /tmp/dominium_install.dsuplan || true
fi

%preun
if [ $1 -eq 0 ] && [ -x /opt/dominium/artifact_root/setup/dominium-setup ] && [ -f /opt/dominium/.dsu/installed_state.dsustate ]; then
    cd /opt/dominium/artifact_root
    /opt/dominium/artifact_root/setup/dominium-setup --deterministic 1 export-invocation --manifest setup/manifests/product.dsumanifest --state /opt/dominium/.dsu/installed_state.dsustate --op uninstall --scope system --ui-mode cli --frontend-id rpm --out /tmp/dominium_uninstall.dsuinv || true
    /opt/dominium/artifact_root/setup/dominium-setup --deterministic 1 plan --manifest setup/manifests/product.dsumanifest --state /opt/dominium/.dsu/installed_state.dsustate --invocation /tmp/dominium_uninstall.dsuinv --out /tmp/dominium_uninstall.dsuplan || true
    /opt/dominium/artifact_root/setup/dominium-setup --deterministic 1 apply --plan /tmp/dominium_uninstall.dsuplan || true
fi

%files
/opt/dominium
