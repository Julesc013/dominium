#!/bin/sh
set -e

# Minimal postinstall hook: invoke Setup Core only.
#
# The PKG payload stages the canonical artifact layout at:
#   /Library/Application Support/Dominium/artifact_root
#
# This script must not embed install decisions; it maps installer context to CLI flags only.

ARTIFACT_ROOT="/Library/Application Support/Dominium/artifact_root"
CLI_BIN="$ARTIFACT_ROOT/setup/dominium-setup"
MANIFEST_PATH="setup/manifests/product.dsumanifest"
INVOCATION_PATH="/tmp/dominium_install.dsuinv"
PLAN_PATH="/tmp/dominium_install.dsuplan"

if [ -x "$CLI_BIN" ]; then
  (
    cd "$ARTIFACT_ROOT"
    "$CLI_BIN" --deterministic 1 export-invocation --manifest "$MANIFEST_PATH" --op install --scope system --ui-mode gui --frontend-id pkg --out "$INVOCATION_PATH" || true
    "$CLI_BIN" --deterministic 1 plan --manifest "$MANIFEST_PATH" --invocation "$INVOCATION_PATH" --out "$PLAN_PATH" || true
    "$CLI_BIN" --deterministic 1 apply --plan "$PLAN_PATH" || true
  )
fi

exit 0

